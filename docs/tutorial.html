<!DOCTYPE html>
<html>
	<head>
		<title>LiberPHP2 Document</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="description" content="LiberPHP2 Document Preference">
		<link rel="stylesheet" href="css/docs.css" type="text/css" />
		<script></script>
		<script src="http://liberjs.org/liber.js"></script>
		<script src="js/docs.js"></script>
	</head>
	<body>
		<div id="wrapper">
		<nav>
			<h1>LiberPHP2</h1>
			<a href="index.html">About</a>
			<a href="">Tutorial</a>
			<a href="index.php?f=Core.inc">Document</a>
		</nav>
		<dl>
			<dd><a href="#@s_install">Installation</a></dd>
			<dd><a href="#@s_hello">Hello world !</a></dd>
			<dd><a href="#@s_restful">RESTful dispatching</a></dd>
			<dd><a href="#@s_db_model">DB & Model</a></dd>
			<dd><a href="#@s_cache">Use Cache</a></dd>
			<dd><a href="#@s_auth">Auth</a></dd>
			<dd><a href="#@s_test">Unit Test</a></dd>
			<dd><a href="#@s_performance">Performance Test</a></dd>
			<dd><a href="#@s_next">What's Next?</a></dd>
		</dl>
		<article>
			<h2>Tutorial</h2>
			<section id="@s_install">
				<header>Requirement</header>
				<ul>
					<li>PHP 5.4 (with APC, GD2, Memcache(Memcached), PDO, pdo-mysql ...) </li>
					<li>Memcached</li>					
					<li>Smarty (optional)</li>					
				</ul>
				<header>Installation</header>
				<ul>
					<li>Check out from <a href="https://github.com/soyoes/liberphp2">here</a><br> 
						<code>
&gt; cd YOUR_HTTP_DOCUMENT_ROOT
&gt; git clone https://github.com/soyoes/liberphp2 liberphp2
						</code>
					</li>
				</ul>
			</section>
			<section id="@s_hello">
				<header>Hello world</header>
				<ol>
					<li>Create project
						<code>
&gt; cd YOUR_HTTP_DOCUMENT_ROOT/liberphp2
&gt; ./liberphp.php create myproj
&gt; cd ../myproj
						</code>
					</li>
					<li>Configurations
						<code>
&gt; vi liber.php
						</code>
						Change the following lines
						<code>
static $db_engine 	= "mysql";	#<- change to your own
static $db_host		= "127.0.0.1";	
static $db_port		= "3306";	
static $db_name		= "tasks";	#<- change to your own
static $db_user		= "root";	#<- change to your own
static $db_pass		= "root";	#<- change to your own
	
static $cache_hosts	= "localhost";	
static $cache_port	= "11211";	#<- change to your own
						</code>
					</li>
					<li>DB migration (Option)
					<code>		
&gt; php liber.php migrate #run this under your project folder
					</code>
					</li>
					
					<li>Update you Apache configuration<br>
						 Add these rows to your httpd.conf (or extra/httpd-vhosts.conf)
						<code>
&lt;VirtualHost *:80&gt;
    DocumentRoot "YOUR_PROJECT_PATH"
    Options FollowSymLinks
    ServerName YOUR_PROJECT_NAME.dev
    RewriteEngine on
    RewriteRule  images/(.*)$ /webroot/images/$1  [L]
    RewriteRule  css/(.*)$ /webroot/css/$1    [L]
    RewriteRule  js/(.*)$ /webroot/js/$1    [L]
    RewriteRule  ^(.*)\.html$ /webroot/html/$1.htm    [L]
    RewriteRule !\.(php|svg|ttf|htc|ico|gif|png|jpg|jpeg|css|js|swf|html|htm|json)$ /liber.php?__URL__=%{REQUEST_URI} [QSA,NE,L]<br>
&lt;/VirtualHost&gt;
						</code>
					</li>
					<li>Add virtural host IP to your hosts file
					<code> 
# /etc/hosts
127.0.0.1		YOUR_PROJECT_NAME.dev
					</code>
					</li>
					<li>Restart your apache</li>
					<li>Try it by accessing http://YOUR_PROJECT_NAME.dev</li>
				</ol>
			</section>
			<section id="@s_restful">
				<header>RESTful dispatching</header>
				<table>
					<tr>
						<th>URI<br>Pattern</th>
						<th>HTTP<br>Method</th>
						<th>Delegate<br>File</th>
						<th>Delegate<br>Function</th>
					</tr>
					<tr>
						<td>[/PATH]/CONTROLLER_NAME[/ID]</td>
						<td>
							GET<br>
							POST<br>
							PUT<br>
							DELETE
						</td>
						<td>controllers/CONTROLLER_NAME.inc</td>
						<td>
							get($params) <samp >//@see <a href="#@rest_example_1">example_1</a></samp><br>
							post($params) <samp >//@see <a href="#@rest_example_2">example_2</a></samp><br>
							put($params)<br>
							delete($params)<br>
						</td>
					</tr>
					<tr>
						<td>[/PATH]/CONTROLLER_NAME[/ID]/ACTION_NAME[/ID]</td>
						<td>
							GET<br>
							POST<br>
							PUT<br>
							DELETE
						</td>
						<td>controllers/CONTROLLER_NAME.inc</td>
						<td>ACTION_NAME($params) <samp >//@see <a href="#@rest_example_3">example_3</a></samp></td>
					</tr>
					<tr>
						<td>/@SCHEMA_NAME[/ID]</td>
						<td>
							GET<br>
							POST<br>
							PUT<br>
							DELETE
						</td>
						<td>restful/SCHEMA_NAME.inc
							<br>(Optional, you can do auth check or filtering here)</td>
						<td>
							get($params) <samp >//Optional, @see <a href="#@rest_example_4">example_4</a></samp><br>
							post($params) <samp >//Optional, @see <a href="#@rest_example_5">example_5</a></samp><br>
							put($params) <samp >//Optional, @see <a href="#@rest_example_6">example_6</a></samp><br>
							delete($params) //Optional<br>
						</td>
					</tr>
				</table>
				
				<div id="@rest_example_1" class="example">
					<h4>Example_1 : Call controller with default action using GET method</h4>
					<p>Given that the URI = /mycontroller?id=1&name=sss</p>
					<p>Your controller file (path = controllers/mycontroller.inc) </p>
					<code>
&lt;?php
	function get($params){
		//all request parameters are encapsulated in $params
		render_json($params);
		//also you can use render_html(with smarty) 
		//or render_text to send plain text 
	}
?&gt;
					</code>
					<p>The result will be : </p>
					<code>
{"id":1,"name":"sss"}
					</code>
				</div>
				<div id="@rest_example_2" class="example">
					<h4>Example_2 : Call controller with default action using POST method</h4>
					<code>
#in your html with jquery 
&lt;script&gt;
$.post('/mycontroller',{id:1,title:"blah blah..."});
&lt;/script&gt;

#in your controllers/mycontroller.inc
&lt;?php
...
	function post($params){
		//all request parameters are encapsulated in $params
		render_json($params); //params = {id:1,title:"blah blah..."}
	}
					</code>
				</div>
				<div id="@rest_example_3" class="example">
					<h4>Example_3 : Call controller with action name</h4>
					<code>
# call mycontroller/myaction?name=php
# in your controllers/mycontroller.inc
&lt;?php
...
	function myaction($params){
		render_text($params["name"]);
	}
#the result will be "php"
					</code>
				</div>
				<div id="@rest_example_4" class="example">
					<h4>Example_4 : Use automatical RESTful mechanism to GET data</h4>
					<code>
#Get newest 20 tasks from tasks table
&gt; curl http://myproj.dev/@tasks?order=desc&sort=updAt&limit=20

#Get tasks that title like '%test%' and register after 2013-10-30
&gt; curl http://myproj.dev/@tasks?title@like=test&amp;regAt@gt=2013-10-30

#Get task with id=35
&gt; curl http://myproj.dev/@tasks/35

#you don't need to write server code, liberPHP does this for you.
					</code>
				</div>
				<div id="@rest_example_5" class="example">
					<h4>Example_5 : Use automatical RESTful mechanism to POST new record</h4>
					<code>
#in your html with jquery 
&lt;script&gt;
$.post('/@tasks',{title:"blah blah..."});
&lt;/script&gt;

#the result will be 
{id:75, title:"blah blah... "} //75 is the last insert id

#you don't need to write server code, liberPHP does this for you.
					</code>
				</div>
				<div id="@rest_example_6" class="example">
					<h4>Example_6 : Use automatical RESTful mechanism to Update record</h4>
					<code>
#in your html with jquery 
&lt;script&gt;
$.put('/@tasks/75',{title:"blah new"}); //you must use PUT method here
&lt;/script&gt;

#the result will be 
{id:75, title:"blah new"} 

#you don't need to write server code, liberPHP does this for you. 
					</code>
				</div>
				<div id="@rest_example_7" class="example">
					<h4>Example_7 : Use automatical RESTful mechanism with filter</h4>
					<p>if you want to do permision check upon auto RESTful request<br>
						you may just simply add delegate methods under /restful/YOUR_SCHEMA.inc
					</p>
					
					<code>
#in your html with jquery 
&lt;script&gt;
$.put('/@tasks/75',{title:"blah new"}); //you must use PUT method here
&lt;/script&gt;

#in your restful/tasks.inc
&lt;?php

/**
* Delegate method, 
* the name must obey the rules of rest_{SCHEMA_NAME}_{METHOD_NAME}
* @param $table: tablename
* @param $params: http request params
*/
function rest_tasks_post($table, $params){ 
	if(!isset($_SESSION["userId"])) //e.g. for login user only
		return false;
	return true;
}

#if the is not loged in then the result will be 
{code:401, message:"RESTful ERROR : Sorry, You are not permited to do that."} 
					</code>
				</div>
				
			</section>
			<section id="@s_db_model">
				<header>DB & Model</header>
				<div>
					<h4>DB Query</h4>
					<code>
/* 
* if useCache == true
* 	we will get result from Cache first.with $sql as key
* 	if there is no data in cache. the result from db will be add to cache
* @see <a>Use Cache</a> for more information
*/
$res = db_query($sql,$useCache=false); //$res is assoc-array 
					</code>
				</div>
				<div>
					<h4>DB Query With Condition</h4>
					<code>
/*
* syntax : db_find(tablename, conditions);
* @see <a href="index.php?f=DB.inc">DB.inc</a> for more information about conditions.
*/
$res = db_find("tasks", [
	"@fields" => "id",
	"regAt@>" => "2013-10-30",
	"title@?" => "Milk",
]);
//=select id from tasks where regAt>'2013-10-30' and title like '%Milk%' 					
					</code>
					<h5>DB Query With Model</h5>
					<code>
$m = Model::factory("tasks");
$res = $m->find(["regAt@>"=>'2013-10-30']);					
					</code>
				</div>
				<div>
					<h4>DB Insert & Update</h4>
					<code>
db_save('tasks',[title=>'My New Task'],true);
//=insert into tasks (title,regAt) values('My New Task',$now);
//returns [title='My New Task',id:5,regAt:$now]

db_save('tasks',[id=>3, title=>'New title']);
//=update tasks set title='New title' where id=3 					
					</code>
					<h5>DB Insert/Update With Model</h5>
					<code>
$m = Model::factory("tasks");
$m->fetch(3); //fetch data where id=3
$m->set("title","New Title With Model");
$m->save(); 
//=update tasks set title='New title With Model' where id=3 
					
					</code>
				</div>
				<div>
					<h4>DB Insert Multiple Rows</h4>
					<code>
db_import("tasks",[
	[title=>"task1"],
	[title=>"task2",priority=>1],
	[title=>"task3"]
]);
//=Insert into tasks (title,priority,regAt) 
// values ("tasks1",0,$now),("tasks2",1,$now),("tasks3",0,$now) 					
					</code>
				</div>
				<div>
					<h4>DB Transaction</h4>
					<code>
$res = db_trans([
	"insert into tasks (title) values ('my title')", 
	"select LAST_INSERT_ID() as 'last_id'"
]);
$id = $res[0]["last_id"];
//insert into db and get the last inserted id;
//if there are errors, db->rollback will be called automatically
					</code>
				</div>
			</section>
			<section id="@s_cache">
				<header>Use Cache</header>
				<ul>
				<li>We use both APC & Memcached as our cache system 
				<code>
Coming soon ...
				</code>	
				</li>
				</ul>
			</section>
			<section id="@s_auth">
				<header>Auth</header>
				<ol>
				<li>Under standing Filters
					<code>
If you have the exp of playing with J2EE servlet.
You could be familiar with the following process.

-> 1st filter->start()
	-> 2nd filter->start()
		-> nth filter->start()
		 	-> CONTROLLER.inc :: ACTION($params)
		-> nth filter->end()
	-> 2nd filter->end()
-> 1st filter->end()

We Use Filters to check Auth
					</code>
				</li>
				
				<li>AuthFilter Example
					<code>
Coming soon ...
					</code>				
				</li>
				</ol>
			</section>
			<section id="@s_test">
				<header>Unit Test</header>
				<ol>
					<li>Create test case file under /test with a name of ${YOUR_CONTROLLER}.json</li> 
  					<li>Add test case to /test/${YOUR_CONTROLLER}.json<br>
  						Example:<br>
  						<code>
{
"add":[
	{
		"method":"GET",
		"params":{
			"uid":"abcdef",
			"data":[
				"movie_1009_1315480852_1315780852",
				"shows_1007_1315880852_1316080852"
			]	
		}
	}
],
"update":[
	{
		"method":"GET",
		"params":{
			"uid":"abcdef",
			"data":[
				"1_test_1009_1315480852_1315780852",
				"2_test_1007_1315880852_1316080852"
			]
		}
	},
	{
		"method":"GET",
		"params":{
			"uid":"abcdef",
			"data":"1_test_1009_1315480852_1315780852"
		}
	}
]
}
  						</code>
  					</li>
  					<li>Debug with URL of /${YOUR_CONTROLLER}/test_${YOUR_ACTION}, without any parameters!.</li>
				</ol>
			</section>
			<section id="@s_performance">
				<header>Performance Test</header>
				<p>Test tool : ApacheBench</p>
				<code>&gt; ab -c 100 -n 10000 URL</code>
				<table>
					<tr>
						<th>Pattern</th>
						<th>Example URL</th>
						<th>Average Response Time</th>
						<th>Description</th>
					</tr>
					<tr>
						<td>Direct access to php file</td>
						<td>/test.php</td>
						<td>8ms</td>
						<td>test.php is under DocumentRoot<br>
							No session
						</td>
					</tr>
					<tr>
						<td>php file with apache rewrite</td>
						<td>/test.php</td>
						<td>13ms</td>
						<td>test.php is under DocumentRoot/mypath<br>No session</td>
					</tr>
					<tr>
						<td>php file under liberPHP</td>
						<td>/test.php</td>
						<td>14ms</td>
						<td>test.php is under DocumentRoot/liberProj/<br>No session</td>
					</tr>
					<tr>
						<td><b>liberPHP</b></td>
						<td>/top/test</td>
						<td><b>27-30</b>ms</td>
						<td>Including (1ms-4ms All-in-one)<br>
							Dispatching (3ms-5ms)<br>
							Load & exec Filters(1ms - 3ms)<br>
							Session start (2-5ms, memcached base)<br>
							Use echo to write HTML code.
							</td>
					</tr>
					<tr>
						<td><b>liberPHP</b> with embeded HTML Render</td>
						<td>/top/test</td>
						<td><b>32-41</b>ms</td>
						<td>Use Embeded Template engine to render HTML</td>
					</tr>
					<tr>
						<td><b>liberPHP</b> with Smarty</td>
						<td>/top/test</td>
						<td><b>71</b>ms</td>
						<td>Use Smarty to render HTML</td>
					</tr>
					<tr>
						<td><b>CakePHP</b> with Smarty</td>
						<td>/top/test</td>
						<td><b>Timeout</b><br><b>10371</b>ms (c=100,n=100)</td>
						<td>Use Smarty to render HTML<br>
							With default performance options,<br>
							Using .htaccess(default)<br>
							And there is no error on the page.
						</td>
					</tr>
				</table>
			</section>
			<section id="@s_next">
				<header>What's Next?</header>
			</section>
		<footer> @Author : soyoes 2014</footer>
		</article>
	</div>
	
	</body>
</html>